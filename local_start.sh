#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะปะพะบะฐะปัะฝะพะณะพ ะทะฐะฟััะบะฐ TripCraftBot
# ะัะฟะพะปัะทัะตั ะบะตัะธัะพะฒะฐะฝะธะต Docker ะดะปั ะฑััััะพะน ะฟะตัะตัะฑะพัะบะธ

set -e  # ะััะฐะฝะพะฒะบะฐ ะฟัะธ ะพัะธะฑะบะต

echo "๐ ะะฐะฟััะบ TripCraftBot ะปะพะบะฐะปัะฝะพ..."

# ะัะพะฒะตััะตะผ, ััะพ Docker ะทะฐะฟััะตะฝ
if ! docker info > /dev/null 2>&1; then
    echo "โ Docker ะฝะต ะทะฐะฟััะตะฝ. ะะฐะฟัััะธัะต Docker Desktop ะธ ะฟะพะฟัะพะฑัะนัะต ัะฝะพะฒะฐ."
    exit 1
fi

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต .env ัะฐะนะปะฐ
if [ ! -f .env ]; then
    echo "โ ะคะฐะนะป .env ะฝะต ะฝะฐะนะดะตะฝ. ะกะพะทะดะฐะนัะต ะตะณะพ ะฝะฐ ะพัะฝะพะฒะต .env.example"
    exit 1
fi

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัััะตััะฒัััะธะต ะบะพะฝัะตะนะฝะตัั
echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัััะตััะฒัััะธะต ะบะพะฝัะตะนะฝะตัั..."
docker compose down --remove-orphans 2>/dev/null || true

# ะฃะดะฐะปัะตะผ ััะฐััะน ะพะฑัะฐะท ะฑะพัะฐ ะดะปั ะฟัะธะฝัะดะธัะตะปัะฝะพะน ะฟะตัะตัะฑะพัะบะธ
echo "๐๏ธ  ะฃะดะฐะปัะตะผ ััะฐััะน ะพะฑัะฐะท ะฑะพัะฐ..."
docker rmi tripcraftbot-tripcraft-bot 2>/dev/null || true

# ะกะพะฑะธัะฐะตะผ ะธ ะทะฐะฟััะบะฐะตะผ ั ะบะตัะธัะพะฒะฐะฝะธะตะผ
echo "๐จ ะะตัะตัะพะฑะธัะฐะตะผ ะธ ะทะฐะฟััะบะฐะตะผ ะบะพะฝัะตะนะฝะตัั..."
docker compose up --build --force-recreate

echo "โ TripCraftBot ะทะฐะฟััะตะฝ!"
echo "๐ Ngrok UI ะดะพัััะฟะตะฝ ะฝะฐ: http://localhost:4040"
echo "๐ ะะพะณะธ ะฑะพัะฐ: docker logs tripcraft-bot -f"
echo "๐ ะััะฐะฝะพะฒะบะฐ: Ctrl+C ะธะปะธ docker compose down"
